# `.gitlab-ci.yml` — CI/CD Pipeline

## Role in the project

This file defines the full GitLab CI/CD pipeline. It orchestrates **automatic versioning, wheel building, package publishing, and GitLab release creation** depending on the branch or event that triggered the pipeline.

---

## Pipeline stages

```
version → build → publish → release
```

| Stage | Purpose |
|---|---|
| `version` | Compute next version, create git tag |
| `build` | Build the Python wheel |
| `publish` | Upload wheel to GitLab Package Registry |
| `release` | Create a GitLab Release linked to the tag |

---

## Global variables

```yaml
variables:
  PYTHON_VERSION: "3.10"
```

A single variable centralises the Python version used across all jobs, making upgrades a one-line change.

---

## Job: `create-tag` (stage: `version`)

### What it does

Handles **automatic tagging** for `main` and `develop` branches. It never runs on tag pipelines or merge request events.

### `main` branch flow

1. Runs `cz bump --dry-run --get-next` to preview the next semver computed from conventional commit messages since the last tag.
2. Runs `cz bump --yes` to actually bump `__init__.py` and create the tag.
3. Pushes the bump commit and the new tag to `main`.

The version is determined entirely by commit message prefixes (`feat:` → minor, `fix:` → patch, `BREAKING CHANGE` → major).

### `develop` branch flow

1. Reads `__version__` from `__init__.py` as the base version (e.g. `1.2.3`).
2. Scans existing git tags matching `1.2.3rc*` and finds the highest RC number.
3. Creates and pushes a new annotated tag: `1.2.3rc<N+1>`.

No file is modified — only a tag is created.

### Authentication

```yaml
- git remote set-url origin https://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
```

A personal access token (`CI_PUSH_TOKEN`) is injected as a CI variable to allow the job to push commits and tags back to the repository.

### Rules summary

| Condition | Runs? |
|---|---|
| Tag pipeline | ❌ Never |
| Merge request event | ❌ Never |
| `main` push (not a bump commit) | ✅ Always |
| `develop` push (not a bump commit) | ✅ Always |
| Any other branch | ❌ Never |

The `!~ /^bump:/` guard prevents an infinite loop: when Commitizen pushes its bump commit, the job does not re-trigger.

---

## Job: `build_wheel` (stage: `build`)

### What it does

Runs `uv build` to produce a `.whl` and `.tar.gz` in the `dist/` directory. The artifacts are passed to the `publish_wheel` job.

### Version resolution at build time

Hatchling calls `hatch_build.py::get_version()`. On a tag pipeline, `CI_COMMIT_TAG` is set so the wheel is stamped with the exact tag (e.g. `1.2.3`).

### Rules summary

| Condition | Runs? |
|---|---|
| Tag pipeline | ✅ Always |
| `main` push | ❌ (tag pipeline handles it) |
| `develop` push | ❌ (tag pipeline handles it) |
| Merge request | ✅ Always (build validation) |
| All other branches | ✅ Always (local dev feedback) |

---

## Job: `publish_wheel` (stage: `publish`)

### What it does

Uses `twine` to upload the wheel built in the previous stage to the **GitLab Package Registry** (PyPI-compatible endpoint).

```yaml
python -m twine upload \
  --repository-url "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi" \
  -u gitlab-ci-token \
  -p "${CI_JOB_TOKEN}" \
  dist/*
```

Authentication uses the built-in `CI_JOB_TOKEN` — no extra secrets needed.

### Rules

Mirrors `build_wheel` exactly: publishes on tag pipelines, MR events, and feature branches; skips direct pushes to `main` and `develop` (which immediately trigger a tag pipeline anyway).

---

## Job: `create-release` (stage: `release`)

### What it does

Creates a **GitLab Release** attached to the current tag using the native `release:` keyword. It only runs on tag pipelines.

```yaml
release:
  tag_name: $CI_COMMIT_TAG
  description: "Release $CI_COMMIT_TAG of components in $CI_PROJECT_PATH"
```

This makes the release visible in the GitLab UI under **Deployments → Releases**, with the tag and description automatically linked.

---

## Full pipeline flow — end to end

```
Developer pushes to main with conventional commits
        │
        ▼
create-tag (version stage)
  └─ cz bump → updates __init__.py, pushes bump commit + tag (e.g. 1.2.3)
        │
        ▼  (tag pipeline triggered automatically)
build_wheel  →  publish_wheel  →  create-release
  └─ uv build      └─ twine upload    └─ GitLab Release 1.2.3
```

```
Developer pushes to develop
        │
        ▼
create-tag (version stage)
  └─ reads __init__.py → pushes tag 1.2.3rc2
        │
        ▼  (tag pipeline triggered automatically)
build_wheel  →  publish_wheel  →  create-release
  └─ uv build      └─ twine upload    └─ GitLab Release 1.2.3rc2
```

---

## Summary

```
.gitlab-ci.yml
├── create-tag   → automates semver tagging (main) and RC tagging (develop)
├── build_wheel  → builds the wheel on tags, MRs, and feature branches
├── publish_wheel→ pushes wheel to GitLab Package Registry
└── create-release → creates a GitLab Release on every tag
```
